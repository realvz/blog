<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Using eStargz to reduce container startup time on Amazon EKS</title>
<link rel="stylesheet" href="/assets/built/screen.css?v=ce0a9a97d4">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400;1,700&family=Mulish:ital,wght@0,400;0,700;0,800;1,400;1,700&display=swap">
<script>
        if (localStorage.getItem('alto_dark') == 'true') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>
<meta name="description" content="Large containers are slow to start. eStargz snapshotter gets container image layers on the fly.">
<link rel="icon" href="https://digitalpress.fra1.cdn.digitaloceanspaces.com/clrvv0c/2023/04/code-branch.png" type="image/png">
<link rel="canonical" href="https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta property="og:site_name" content="Re Alvarez Parmar&#x27;s Blog">
<meta property="og:type" content="article">
<meta property="og:title" content="Using eStargz to reduce container startup time on Amazon EKS">
<meta property="og:description" content="Large containers are slow to start. eStargz snapshotter gets container image layers on the fly.">
<meta property="og:url" content="https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/">
<meta property="og:image" content="https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;2000content/images/size/w1200">
<meta property="article:published_time" content="2022-10-25T23:11:00.000Z">
<meta property="article:modified_time" content="2022-10-27T03:03:53.000Z">
<meta property="article:tag" content="Amazon EKS">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Containers">
<meta property="article:tag" content="Containerd">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Using eStargz to reduce container startup time on Amazon EKS">
<meta name="twitter:description" content="Large containers are slow to start. eStargz snapshotter gets container image layers on the fly.">
<meta name="twitter:url" content="https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;2000content/images/size/w1200">
<meta name="twitter:label1" content="Written by">
<meta name="twitter:data1" content="Re Alvarez Parmar">
<meta name="twitter:label2" content="Filed under">
<meta name="twitter:data2" content="Amazon EKS, Kubernetes, Containers, Containerd">
<meta name="twitter:site" content="@realz">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="800">
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Re Alvarez Parmar&#x27;s Blog",
        "url": "https://realvz.github.io/blog/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://digitalpress.fra1.cdn.digitaloceanspaces.com/clrvv0c/2023/04/code-branch.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Re Alvarez Parmar",
        "url": "https://realvz.github.io/blog/author/re-2/",
        "sameAs": []
    },
    "headline": "Using eStargz to reduce container startup time on Amazon EKS",
    "url": "https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/",
    "datePublished": "2022-10-25T23:11:00.000Z",
    "dateModified": "2022-10-27T03:03:53.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&ixlib=rb-4.0.3&q=80&w=2000content/images/size/w1200",
        "width": 1200,
        "height": 800
    },
    "keywords": "Amazon EKS, Kubernetes, Containers, Containerd",
    "description": "Large containers are slow to start. eStargz snapshotter gets container image layers on the fly. ",
    "mainEntityOfPage": "https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/"
}
    </script>
<meta name="generator" content="Ghost 5.79">
<link rel="alternate" type="application/rss+xml" title="Re Alvarez Parmar&#x27;s Blog" href="https://realvz.github.io/blog/rss/">
<script defer src="https://cdn.jsdelivr.net/ghost/portal@~2.37/umd/portal.min.js" data-i18n="false" data-ghost="https://realvz.github.io/blog/" data-key="875679d7145ae8b3c4db5168c2" data-api="https://realvz.github.io/blog/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
<script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="875679d7145ae8b3c4db5168c2" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://realvz.github.io/blog/" crossorigin="anonymous"></script>
<link href="https://realvz.github.io/blog/webmentions/receive/" rel="webmention">
<script defer src="/public/cards.min.js?v=ce0a9a97d4"></script>
<link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=ce0a9a97d4">
<script defer src="/public/member-attribution.min.js?v=ce0a9a97d4"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-B5XRB3YVTR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B5XRB3YVTR');
</script><style>:root {--ghost-accent-color: #3a88fe;}</style>
</head>
<body class="post-template tag-amazon-eks tag-kubernetes tag-containers tag-containerd has-serif-title has-serif-body">
<div class="site">
<header class="site-header container">
<div class="navbar">
<div class="navbar-left">
<div class="burger hidden-lg hidden-xl"></div>
<a class="logo" href="https://realvz.github.io/blog">
<span class="logo-text">Re Alvarez Parmar&#x27;s Blog</span>
</a> <div class="sep hidden-xs hidden-sm hidden-sm"></div>
<nav class="main-menu hidden-xs hidden-sm hidden-md">
<ul class="nav-list u-plain-list">
<li class="menu-item menu-item-home"><a class="menu-item-link" href="https://realvarez.com">Home</a></li>
<li class="menu-item menu-item-about"><a class="menu-item-link" href="https://realvz.github.io/blog/about/">About</a></li>
</ul>
</nav>
</div>
<div class="navbar-right">
<div class="toggle-track">
<div class="toggle-moon"><i class="icon icon-brightness-2"></i></div>
<div class="toggle-sun"><i class="icon icon-white-balance-sunny"></i></div>
<div class="toggle-thumb"></div>
</div>
</div>
</div>
</header> <div class="site-content">
<div class="content-area">
<main class="site-main">
<article class="post tag-amazon-eks tag-kubernetes tag-containers tag-containerd single-post">
<header class="post-header big-title container medium">
<h1 class="post-title">Using eStargz to reduce container startup time on Amazon EKS</h1>
<div class="post-meta">
<span class="post-meta-item post-meta-date">
<time datetime="2022-10-25">Oct 25, 2022</time>
</span>
<span class="post-meta-item post-meta-length">
7 min read
</span>
<span class="post-meta-item post-meta-tags">
<a class="post-tag post-tag-amazon-eks" href="/tag/amazon-eks/" title="Amazon EKS">Amazon EKS</a><a class="post-tag post-tag-kubernetes" href="/tag/kubernetes/" title="Kubernetes">Kubernetes</a><a class="post-tag post-tag-containers" href="/tag/containers/" title="Containers">Containers</a><a class="post-tag post-tag-containerd" href="/tag/containerd/" title="Containerd">Containerd</a>
</span>
</div>
</header> <figure class="post-media container large">
<div class="u-placeholder horizontal">
<a class="post-image-link" href="/using-estargz-to-reduce-container-startup-time-on-amazon-eks/">
<img class="post-image lazyload u-object-fit" data-srcset="https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;400 400w, https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;750 750w, https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960 960w, https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1140 1140w, https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1920 1920w" data-sizes="auto" src="https://images.unsplash.com/photo-1578923931302-7fd9b3495be7?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDExfHxob3VyZ2xhc3N8ZW58MHx8fHwxNjY2NzM5NTc3&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960" srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Using eStargz to reduce container startup time on Amazon EKS">
</a>
</div>
<figcaption>Photo by <a href="https://unsplash.com/@alexandar_todov?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit">Alexandar Todov</a> / <a href="https://unsplash.com/?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit">Unsplash</a></figcaption>
</figure>
<div class="post-content gh-content kg-canvas">
<p>A container image bundles executable code, library, and configuration. Images contain everything an application needs to run. It is a best practice to exclude any file that’s unnecessary for the application packaged in the image. A smaller image means that when you create a container, the container runtime (dockerd or containerd) will have to download fewer bits from the container registry, which will result in faster startup time.</p>
<p>There are cases when the container image becomes significantly large (&gt;500 MB). A common scenario is machine learning workloads. ML workload containers usually package model data necessary for the application. The image size for these containers can easily span in to multiple GBs. As a result, these applications have a slower startup time when the runtime has to pull the image. In fact, <a href="https://www.usenix.org/conference/fast16/technical-sessions/presentation/harter?ref=blog.realvarez.com">research</a> shows that pulling packages accounts for 76% of container start time, but only 6.4% of that data is read.</p>
<h2 id="lazy-pulling">Lazy-pulling</h2>
<p>There are two open source projects designed to improve container startup time. <a href="https://github.com/containerd/stargz-snapshotter?ref=blog.realvarez.com">Stargz</a> and <a href="https://github.com/awslabs/soci-snapshotter?ref=blog.realvarez.com">SOCI</a> are containerd plugins that reduce the cold start time by providing a way to run containers without downloading the entire image. They introduce the concept of <em>lazy pulling</em>, a technique that allows the runtime to download the bits from the container registry as needed.</p>
<p>Using lazy pulling significantly reduces the application startup time. eStargz is a lazily-pullable image format that is compatible with <a href="https://github.com/opencontainers/runtime-spec?ref=blog.realvarez.com">OCI runtimes</a> and standard container registries like DockerHub, GitHub Container Registry.</p>
<h2 id="estargz">eStargz</h2>
<p>The eStargz image format is based on stargz image format by Container Registry Filesystem (CRFS) open source project. <strong>CRFS</strong> is a read-only FUSE filesystem that lets you mount a container image, served directly from a container registry, without pulling it all locally first. The project introduces <strong>S</strong>eekable tar.gz format, which makes tar.gz files seekable using an index.</p>
<h2 id="stargz-snapshotter-plugin">Stargz Snapshotter plugin</h2>
<p>Stargz snapshotter is implemented as a <a href="https://github.com/containerd/containerd/blob/04985039cede6aafbb7dfb3206c9c4d04e2f924d/PLUGINS.md?ref=blog.realvarez.com#proxy-plugins">proxy plugin</a> daemon (<code>containerd-stargz-grpc</code>) for containerd. When containerd starts a container, it queries the rootfs snapshots to stargz snapshotter daemon through a unix socket. This snapshotter remotely mounts queried eStargz layers from registries on the node and provides these mount points as remote snapshots to containerd. The plugin uses FUSE to mount eStargz layers directly from the container registry.</p>
<p><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/28146E5F-3F27-4D41-94B7-CF6EF7615505/C70CF5ED-93B1-43E2-B0C2-41D09499BBC8_2/kxUcYlMPhkl9lEW9PWLWDQpsZcldhni1S81OJseSGZgz/Image.tiff" alt="Image" loading="lazy"></p>
<h2 id="running-estargz-images-on-amazon-eks">Running eStargz images on Amazon EKS</h2>
<p>eStargz images are a little different from the images you’d build using <code>docker build</code>. In order to create an image that supports lazy pulling, you'll need an eStargz-aware image builder or a converter.</p>
<p>I am going to build my eStargz image using nerdctl, which is an eStargz-aware image builder. Since image size is not an issue, I will use Debian Jessie as the base image to demo. To make the image size artificially large, I will include twenty 50 MB files.</p>
<p>Lets generate large files containing random text:</p>
<pre><code>mkdir files
for i in {0..20}; do base64 /dev/urandom | head -c 50000000 &gt; files/file${i}.txt; done
</code></pre>
<p>Create a DockerFile:</p>
<pre><code>cat &gt; Dockerfile &lt;&lt;EOF
FROM debian:jessie
RUN apt-get update &amp;&amp; apt-get install -y \
    vim
COPY files .

EOF
</code></pre>
<p>I am going to store my image in Amazon ECR. I’ll create an ECR repository:</p>
<pre><code>ECR_URI=$(aws ecr create-repository \
  --repository-name estargz-demo \
  --query 'repository.repositoryUri' \
  --output text)
</code></pre>
<p>Use nerdctl to create container image:</p>
<pre><code>sudo nerdctl build -t ${ECR_URI}:1 .
</code></pre>
<p>The image is not in eStargz formatted right now, I’ll have to convert it:</p>
<pre><code>nerdctl image convert --estargz --oci \
  ${ECR_URI}:1 ${ECR_URI}:1-esgz
</code></pre>
<p>The resulting images:</p>
<pre><code>nerdctl images
REPOSITORY                                                   TAG       IMAGE ID        CREATED           PLATFORM       SIZE       BLOB SIZE
account.dkr.ecr.us-west-2.amazonaws.com/estargz-demo    1         798b85a131ed    31 minutes ago    linux/amd64    1.2 GiB    828.8 MiB
account.dkr.ecr.us-west-2.amazonaws.com/estargz-demo    1-esgz    81b0ffd2a4a3    36 seconds ago    linux/amd64    0.0 B      832.3 MiB
</code></pre>
<p>Login to ECR and push the image to ECR:</p>
<pre><code>aws ecr get-login-password | sudo nerdctl login \
   --username AWS \
   --password-stdin \
   $ECR_URI
nerdctl push ${ECR_URI}:1-esgz
</code></pre>
<p>The image is now available in ECR and I can start running it in my EKS cluster.</p>
<h2 id="create-a-managed-node-group-that-uses-containerd">Create a managed node group that uses containerd</h2>
<p>EKS nodes currently don’t enable containerd by default. I’ll create a node group that uses containerd.</p>
<p>Create environment variables for AWS Region and EKS cluster name:</p>
<pre><code>AWS_REGION=&lt;Your AWS Region&gt;
CLUSTER_NAME=&lt;Your EKS cluster's name&gt;
</code></pre>
<p>First, I need to retrieve the id of the EKS optimized AMI in my region:</p>
<pre><code>aws ssm get-parameter --name /aws/service/eks/optimized-ami/1.23/amazon-linux-2/recommended/image_id --region us-west-2 --query &quot;Parameter.Value&quot; --output text
</code></pre>
<pre><code>cat &gt; containerd-mng.yaml &lt;&lt;EOF
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: $CLUSTER_NAME
  region: $AWS_REGION

managedNodeGroups:
  - name: containerd-mng
    minSize: 1
    maxSize: 1
    desiredCapacity: 1
    instanceType: m5.xlarge
    ami: $AMI_ID
    overrideBootstrapCommand: |
      #!/bin/bash
      /etc/eks/bootstrap.sh Socrates --container-runtime containerd
    
EOF
</code></pre>
<h2 id="preparing-eks-nodes-to-use-estargz">Preparing EKS nodes to use eStargz</h2>
<p>Next, I need to install eStargz snapshotter plugin on my worker node. I use AWS Systems Manager on my nodes, so I will connect to the containerd node.</p>
<pre><code>aws ssm start-session --target &lt;Instance ID of the worker node&gt;
</code></pre>
<p>Connect to the node (using ssh or Systems Manager) and back up the current containerd config file (/etc/containerd/config.toml) and replace it with:</p>
<pre><code>sudo mv /etc/containerd/config.toml /etc/containerd/config.toml.bak
cat &gt; config.toml &lt;&lt;EOF
version = 2
root = &quot;/var/lib/containerd&quot;
state = &quot;/run/containerd&quot;

[grpc]
address = &quot;/run/containerd/containerd.sock&quot;

[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]
default_runtime_name = &quot;runc&quot;
snapshotter = &quot;stargz&quot;
disable_snapshot_annotations = false

[plugins.&quot;io.containerd.grpc.v1.cri&quot;]
sandbox_image = &quot;602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/pause:3.5&quot;

[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]
runtime_type = &quot;io.containerd.runc.v2&quot;

[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
SystemdCgroup = true

[plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]
bin_dir = &quot;/opt/cni/bin&quot;
conf_dir = &quot;/etc/cni/net.d&quot;

[proxy_plugins]
  [proxy_plugins.stargz]
    type = &quot;snapshot&quot;
    address = &quot;/run/containerd-stargz-grpc/containerd-stargz-grpc.sock&quot;
EOF
sudo mv config.toml /etc/containerd/config.toml
</code></pre>
<p>Install FUSE:</p>
<pre><code>sudo yum install fuse -y
sudo modprobe fuse
sudo bash -c 'echo &quot;fuse&quot; &gt; /etc/modules-load.d/fuse.conf'
</code></pre>
<p>Install the snapshotter from its <a href="https://github.com/containerd/stargz-snapshotter/releases?ref=blog.realvarez.com">GitHub</a> repository:</p>
<pre><code>wget https://github.com/containerd/stargz-snapshotter/releases/download/v0.12.1/stargz-snapshotter-v0.12.1-linux-amd64.tar.gz
sudo tar xvzf stargz-snapshotter-v0.12.1-linux-amd64.tar.gz -C /usr/local/bin
sudo wget -O /etc/systemd/system/stargz-snapshotter.service https://raw.githubusercontent.com/containerd/stargz-snapshotter/main/script/config/etc/systemd/system/stargz-snapshotter.service
sudo systemctl enable --now stargz-snapshotter
</code></pre>
<p>Finally, restart the containerd and kubelet:</p>
<pre><code>sudo systemctl restart containerd
sudo systemctl restart kubelet
</code></pre>
<h2 id="test-lazy-pulling">Test lazy-pulling</h2>
<p>I will now run the pod using my eStargz formatted image. Create a manifest for a new pod and replace the node name with the newly created node:</p>
<pre><code>cat &gt; estargz-pod.yaml &lt;&lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: stargz-demo
spec:
  containers:
  - name: stargz-demo
    image: ${ECR_URI}:1-esgz
    command: [ &quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot; ]
    args: [ &quot;while true; do sleep 30; done;&quot; ]
  nodeName: ip-192-168-32-236.us-west-2.compute.internal
EOF
</code></pre>
<p>The pod started in 2 seconds:</p>
<pre><code>k get pods
NAME                            READY   STATUS        RESTARTS      AGE
stargz-demo                     1/1     Running       0             2s
</code></pre>
<p>To compare, I ran the same pod on another node that didn’t use containerd. It took 45 seconds to start the same image. That’s a lot of improvement in pod startup time!!</p>
<p>Image pull time <em>without</em> eStargz:</p>
<p><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/28146E5F-3F27-4D41-94B7-CF6EF7615505/46004B64-228E-4F69-B607-D0FBBF391149_2/AbByT341edypWUhHSsEY1F3qSAmSIf9KuHJwYVgzJQ0z/Image.jpeg" alt="Image" loading="lazy"></p>
<p>Image pull with eStargz:</p>
<p><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/28146E5F-3F27-4D41-94B7-CF6EF7615505/495F26BE-BA38-48DF-B3F6-9915FDF52E5C_2/N7tCcNUyi2GGlpNmWfwIzNnBzbdmKsxhWnhSRUVkw7Mz/Image.jpeg" alt="Image" loading="lazy"></p>
<h2 id="prefetching-files">Prefetching files</h2>
<p>What if you wanted the runtime to always download a file and disable lazy-pulling?</p>
<p>eStargz supports prefetching of files. This mitigates runtime performance drawbacks caused by the on-demand fetching of each file.</p>
<p>The example below always pulls <code>ls</code> and <code>bash</code> files before starting the container:</p>
<pre><code>$ cat &lt;&lt;EOF &gt; /tmp/record.json
{ &quot;path&quot; : &quot;/usr/bin/bash&quot; }
{ &quot;path&quot; : &quot;/usr/bin/ls&quot; }
EOF
$ nerdctl image convert --estargz --oci \
    --estargz-record-in=/tmp/record.json \
    ubuntu:21.04 ubuntu:21.04-ls
</code></pre>
<h2 id="seekable-oci-soci">Seekable OCI (SOCI)</h2>
<p>Seekable OCI (SOCI) is a technology open sourced by AWS that enables containers to launch faster by lazily loading the container image. SOCI works by creating an index (SOCI Index) of the files within an existing container image. This index is a key enabler to launching containers faster, providing the capability of extracting an individual file from a container image before downloading the entire archive.</p>
<p>SOCI borrows some of the design principles from stargz-snapshotter, but takes a different approach.</p>
<p>A SOCI index is generated separately from the container image, and is stored in the registry as an <a href="https://github.com/opencontainers/artifacts?ref=blog.realvarez.com">OCI Artifact</a> and linked back to the container image by <a href="https://github.com/opencontainers/tob/blob/main/proposals/wg-reference-types.md?ref=blog.realvarez.com">OCI Reference Types</a>. This means that the container images do not need to be converted, image digests do not change, and image signatures remain valid.</p>
<p>Most OCI registries like DockerHub and ECR do not currently support the &quot;referrers&quot; feature. So you cannot use SOCI unless you run a local <a href="https://oras.land/?ref=blog.realvarez.com">ORAS</a> registry.</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you are looking to reduce container start time for your workloads, eStargz snapshotter is definitely worth a look. You’ll have to change your existing container build pipelines to add a step to convert images though. When SOCI support is available in OCI registries, you’ll be able to lazily-pull images without converting them first.</p>
<p>You’ll also have to install eStargz snapshotter on your nodes and configure containerd to use the plugin. Creating a custom AMI or using AWS Systems manager will be the best way to do that. You could also use a DaemonSet to configure the system, but keep in mind that you’ll need to account for restarting the containerd and kubelet.</p>

</div>
<div class="container medium">
<div class="share u-hover-wrapper">
<a class="share-item share-facebook u-hover-item" href="https://www.facebook.com/sharer.php?u=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/" target="_blank" rel="noopener"><i class="icon icon-facebook"></i></a>
<a class="share-item share-twitter u-hover-item" href="https://twitter.com/intent/tweet?url=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/&text=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS" target="_blank" rel="noopener"><i class="icon icon-twitter"></i></a>
<a class="share-item share-pinterest u-hover-item" href="https://pinterest.com/pin/create/button/?url=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/&media=&description=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS" target="_blank" rel="noopener" data-pin-do="none"><i class="icon icon-pinterest"></i></a>
<a class="share-item share-linkedin u-hover-item" href="https://www.linkedin.com/shareArticle?mini=true&url=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/&title=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS" target="_blank" rel="noopener"><i class="icon icon-linkedin"></i></a>
<a class="share-item share-reddit u-hover-item" href="https://reddit.com/submit?url=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/&title=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS" target="_blank" rel="noopener"><i class="icon icon-reddit"></i></a>
<a class="share-item share-tumblr u-hover-item" href="https://www.tumblr.com/widgets/share/tool?canonicalUrl=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/&title=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS" target="_blank" rel="noopener"><i class="icon icon-tumblr"></i></a>
<a class="share-item share-vk u-hover-item" href="http://vk.com/share.php?url=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/&title=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS" target="_blank" rel="noopener"><i class="icon icon-vk"></i></a>
<a class="share-item share-pocket u-hover-item" href="https://getpocket.com/edit?url=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/" target="_blank" rel="noopener"><i class="icon icon-pocket"></i></a>
<a class="share-item share-telegram u-hover-item" href="https://t.me/share/url?url=https://realvz.github.io/blog/using-estargz-to-reduce-container-startup-time-on-amazon-eks/&text=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS" target="_blank" rel="noopener"><i class="icon icon-telegram"></i></a>
</div> </div>
</article>
<div class="navigation container medium">
<div class="navigation-item navigation-previous">
<a class="navigation-item-link button-arrow button-arrow-left" href="/handling-feedback/">
<i class="button-arrow-icon icon icon-arrow-left"></i> Previous Post
</a>
</div>
<div class="navigation-item navigation-next">
<a class="navigation-item-link button-arrow button-arrow-right" href="/autoscale-kubernetes-metrics-server/">
Next Post <i class="button-arrow-icon icon icon-arrow-right"></i>
</a>
</div>
</div> <section class="related-posts container medium">
<h3 class="related-title"><span class="text">You might also like...</span></h3>
<div class="row">
<div class="col-md-4 related-column">
<article class="post tag-nvidia tag-machine-learning tag-amazon-eks tag-kubernetes">
<figure class="post-media">
<div class="u-placeholder rectangle">
<a class="post-image-link" href="/get-more-out-of-gpus-with-nvidia-multi-instance-gpu/">
<img class="post-image lazyload u-object-fit" data-srcset="https://images.unsplash.com/photo-1536620752150-a7e9e62a62ee?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;M3wxMTc3M3wwfDF8c2VhcmNofDI5fHx2ZXJ0aWNhbCUyMGxpbmVzfGVufDB8fHx8MTY4NDg4NDU5OHww&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;400 400w, https://images.unsplash.com/photo-1536620752150-a7e9e62a62ee?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;M3wxMTc3M3wwfDF8c2VhcmNofDI5fHx2ZXJ0aWNhbCUyMGxpbmVzfGVufDB8fHx8MTY4NDg4NDU5OHww&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;750 750w, https://images.unsplash.com/photo-1536620752150-a7e9e62a62ee?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;M3wxMTc3M3wwfDF8c2VhcmNofDI5fHx2ZXJ0aWNhbCUyMGxpbmVzfGVufDB8fHx8MTY4NDg4NDU5OHww&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960 960w, https://images.unsplash.com/photo-1536620752150-a7e9e62a62ee?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;M3wxMTc3M3wwfDF8c2VhcmNofDI5fHx2ZXJ0aWNhbCUyMGxpbmVzfGVufDB8fHx8MTY4NDg4NDU5OHww&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1140 1140w, https://images.unsplash.com/photo-1536620752150-a7e9e62a62ee?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;M3wxMTc3M3wwfDF8c2VhcmNofDI5fHx2ZXJ0aWNhbCUyMGxpbmVzfGVufDB8fHx8MTY4NDg4NDU5OHww&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1920 1920w" data-sizes="auto" src="https://images.unsplash.com/photo-1536620752150-a7e9e62a62ee?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;M3wxMTc3M3wwfDF8c2VhcmNofDI5fHx2ZXJ0aWNhbCUyMGxpbmVzfGVufDB8fHx8MTY4NDg4NDU5OHww&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960" srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Run more pods per GPU with NVIDIA Multi-Instance GPU">
</a>
</div>
</figure>
<header class="post-header">
<h2 class="post-title">
<a class="post-title-link" href="/get-more-out-of-gpus-with-nvidia-multi-instance-gpu/">Run more pods per GPU with NVIDIA Multi-Instance GPU</a>
</h2>
<div class="post-meta">
<span class="post-meta-item post-meta-date">
<time datetime="2023-05-23">May 23, 2023</time>
</span>
<span class="post-meta-item post-meta-length">
10 min read
</span>
<span class="post-meta-item post-meta-tags">
<a class="post-tag post-tag-nvidia" href="/tag/nvidia/" title="NVIDIA">NVIDIA</a><a class="post-tag post-tag-machine-learning" href="/tag/machine-learning/" title="Machine Learning">Machine Learning</a><a class="post-tag post-tag-amazon-eks" href="/tag/amazon-eks/" title="Amazon EKS">Amazon EKS</a><a class="post-tag post-tag-kubernetes" href="/tag/kubernetes/" title="Kubernetes">Kubernetes</a>
</span>
</div>
</header> </article>
</div>
<div class="col-md-4 related-column">
<article class="post tag-amazon-eks tag-cost tag-kubernetes tag-scaling">
<figure class="post-media">
<div class="u-placeholder rectangle">
<a class="post-image-link" href="/reduce-amazon-eks-cost-by-scaling-node-groups-to-zero/">
<img class="post-image lazyload u-object-fit" data-srcset="https://images.unsplash.com/photo-1591617870684-6e861e6a48ad?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDR8fGdyYXBofGVufDB8fHx8MTY2ODYyODQ5Ng&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;400 400w, https://images.unsplash.com/photo-1591617870684-6e861e6a48ad?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDR8fGdyYXBofGVufDB8fHx8MTY2ODYyODQ5Ng&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;750 750w, https://images.unsplash.com/photo-1591617870684-6e861e6a48ad?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDR8fGdyYXBofGVufDB8fHx8MTY2ODYyODQ5Ng&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960 960w, https://images.unsplash.com/photo-1591617870684-6e861e6a48ad?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDR8fGdyYXBofGVufDB8fHx8MTY2ODYyODQ5Ng&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1140 1140w, https://images.unsplash.com/photo-1591617870684-6e861e6a48ad?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDR8fGdyYXBofGVufDB8fHx8MTY2ODYyODQ5Ng&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1920 1920w" data-sizes="auto" src="https://images.unsplash.com/photo-1591617870684-6e861e6a48ad?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDR8fGdyYXBofGVufDB8fHx8MTY2ODYyODQ5Ng&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960" srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Reduce Amazon EKS cost by scaling node groups to zero">
</a>
</div>
</figure>
<header class="post-header">
<h2 class="post-title">
<a class="post-title-link" href="/reduce-amazon-eks-cost-by-scaling-node-groups-to-zero/">Reduce Amazon EKS cost by scaling node groups to zero</a>
</h2>
<div class="post-meta">
<span class="post-meta-item post-meta-date">
<time datetime="2022-11-16">Nov 16, 2022</time>
</span>
<span class="post-meta-item post-meta-length">
5 min read
</span>
<span class="post-meta-item post-meta-tags">
<a class="post-tag post-tag-amazon-eks" href="/tag/amazon-eks/" title="Amazon EKS">Amazon EKS</a><a class="post-tag post-tag-cost" href="/tag/cost/" title="Cost">Cost</a><a class="post-tag post-tag-kubernetes" href="/tag/kubernetes/" title="Kubernetes">Kubernetes</a><a class="post-tag post-tag-scaling" href="/tag/scaling/" title="Scaling">Scaling</a>
</span>
</div>
</header> </article>
</div>
<div class="col-md-4 related-column">
<article class="post tag-amazon-eks tag-kubernetes tag-scaling">
<figure class="post-media">
<div class="u-placeholder rectangle">
<a class="post-image-link" href="/autoscale-kubernetes-metrics-server/">
<img class="post-image lazyload u-object-fit" data-srcset="https://images.unsplash.com/photo-1616085290809-064fcf10dc4a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDN8fGV4cGFuZHxlbnwwfHx8fDE2Njc1MDg5MTk&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;400 400w, https://images.unsplash.com/photo-1616085290809-064fcf10dc4a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDN8fGV4cGFuZHxlbnwwfHx8fDE2Njc1MDg5MTk&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;750 750w, https://images.unsplash.com/photo-1616085290809-064fcf10dc4a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDN8fGV4cGFuZHxlbnwwfHx8fDE2Njc1MDg5MTk&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960 960w, https://images.unsplash.com/photo-1616085290809-064fcf10dc4a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDN8fGV4cGFuZHxlbnwwfHx8fDE2Njc1MDg5MTk&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1140 1140w, https://images.unsplash.com/photo-1616085290809-064fcf10dc4a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDN8fGV4cGFuZHxlbnwwfHx8fDE2Njc1MDg5MTk&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1920 1920w" data-sizes="auto" src="https://images.unsplash.com/photo-1616085290809-064fcf10dc4a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDN8fGV4cGFuZHxlbnwwfHx8fDE2Njc1MDg5MTk&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960" srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Autoscale Kubernetes Metrics Server">
</a>
</div>
</figure>
<header class="post-header">
<h2 class="post-title">
<a class="post-title-link" href="/autoscale-kubernetes-metrics-server/">Autoscale Kubernetes Metrics Server</a>
</h2>
<div class="post-meta">
<span class="post-meta-item post-meta-date">
<time datetime="2022-11-03">Nov 3, 2022</time>
</span>
<span class="post-meta-item post-meta-length">
6 min read
</span>
<span class="post-meta-item post-meta-tags">
<a class="post-tag post-tag-amazon-eks" href="/tag/amazon-eks/" title="Amazon EKS">Amazon EKS</a><a class="post-tag post-tag-kubernetes" href="/tag/kubernetes/" title="Kubernetes">Kubernetes</a><a class="post-tag post-tag-scaling" href="/tag/scaling/" title="Scaling">Scaling</a>
</span>
</div>
</header> </article>
</div>
</div>
</section>
</main>
</div>
</div>
<footer class="site-footer container large">
<div class="copyright">
Powered by <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a>
</div>
<nav class="footer-nav">
<ul class="nav-list u-plain-list">
<li class="menu-item menu-item-sign-up"><a class="menu-item-link" href="https://realvz.github.io/blog/#/portal/">Sign up</a></li>
</ul>
</nav>
<div class="footer-social">
<a class="footer-social-item footer-social-item-twitter" href="https://twitter.com/realz" target="_blank" rel="noopener" aria-label="Twitter">
<i class="icon icon-twitter"></i>
</a>
<a class="footer-social-item footer-social-item-rss" href="https://feedly.com/i/subscription/feed/https://realvz.github.io/blog/rss/" target="_blank" rel="noopener" aria-label="RSS">
<i class="icon icon-rss"></i>
</a>
</div>
</footer> </div>
<div class="dimmer"></div>
<div class="off-canvas">
<div class="canvas-close">
<i class="canvas-icon icon icon-window-close"></i>
</div>
<div class="mobile-menu"></div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous">
    </script>
<script src="/assets/built/main.min.js?v=ce0a9a97d4"></script>
</body>
</html>