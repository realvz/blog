<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Use containerd to handle k8s.gcr.io deprecation</title>
<link rel="stylesheet" href="/assets/built/screen.css?v=ce0a9a97d4">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400;1,700&family=Mulish:ital,wght@0,400;0,700;0,800;1,400;1,700&display=swap">
<script>
        if (localStorage.getItem('alto_dark') == 'true') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>
<link rel="icon" href="https://digitalpress.fra1.cdn.digitaloceanspaces.com/clrvv0c/2023/04/code-branch.png" type="image/png">
<link rel="canonical" href="https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta property="og:site_name" content="Re Alvarez Parmar&#x27;s Blog">
<meta property="og:type" content="article">
<meta property="og:title" content="Use containerd to handle k8s.gcr.io deprecation">
<meta property="og:description" content="The Kubernetes community is getting ready for yet another major change. Until fall 2022, k8s.gcr.io container registry hosted many Kubernetes community-managed container images like Cluster Autoscaler, metrics-server, cluster-proportional-autoscaler. The “gcr.io” is Google Cloud Registry. In order to be vendor neutral, the community is moving away from using">
<meta property="og:url" content="https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/">
<meta property="og:image" content="https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;2000content/images/size/w1200">
<meta property="article:published_time" content="2023-04-05T06:52:39.000Z">
<meta property="article:modified_time" content="2023-04-05T19:03:17.000Z">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Use containerd to handle k8s.gcr.io deprecation">
<meta name="twitter:description" content="The Kubernetes community is getting ready for yet another major change. Until fall 2022, k8s.gcr.io container registry hosted many Kubernetes community-managed container images like Cluster Autoscaler, metrics-server, cluster-proportional-autoscaler. The “gcr.io” is Google Cloud Registry. In order to be vendor neutral, the community is moving away from using">
<meta name="twitter:url" content="https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;2000content/images/size/w1200">
<meta name="twitter:label1" content="Written by">
<meta name="twitter:data1" content="Re Alvarez Parmar">
<meta name="twitter:site" content="@realz">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="800">
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Re Alvarez Parmar&#x27;s Blog",
        "url": "https://realvz.github.io/blog/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://digitalpress.fra1.cdn.digitaloceanspaces.com/clrvv0c/2023/04/code-branch.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Re Alvarez Parmar",
        "image": {
            "@type": "ImageObject",
            "url": "https://www.gravatar.com/avatar/2ea5788958b69e3c318e7b5c1562a2b4?s=250&r=x&d=mp",
            "width": 250,
            "height": 250
        },
        "url": "https://realvz.github.io/blog/author/re/",
        "sameAs": []
    },
    "headline": "Use containerd to handle k8s.gcr.io deprecation",
    "url": "https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/",
    "datePublished": "2023-04-05T06:52:39.000Z",
    "dateModified": "2023-04-05T19:03:17.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&ixlib=rb-4.0.3&q=80&w=2000content/images/size/w1200",
        "width": 1200,
        "height": 800
    },
    "description": "The Kubernetes community is getting ready for yet another major change. Until fall 2022, k8s.gcr.io container registry hosted many Kubernetes community-managed container images like Cluster Autoscaler, metrics-server, cluster-proportional-autoscaler. The “gcr.io” is Google Cloud Registry. In order to be vendor neutral, the community is moving away from using Google Cloud Registry to host container images.\n\nAs a result, starting March 20th, traffic from the old k8s.gcr.io registry is being redire",
    "mainEntityOfPage": "https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/"
}
    </script>
<meta name="generator" content="Ghost 5.79">
<link rel="alternate" type="application/rss+xml" title="Re Alvarez Parmar&#x27;s Blog" href="https://realvz.github.io/blog/rss/">
<script defer src="https://cdn.jsdelivr.net/ghost/portal@~2.37/umd/portal.min.js" data-i18n="false" data-ghost="https://realvz.github.io/blog/" data-key="875679d7145ae8b3c4db5168c2" data-api="https://realvz.github.io/blog/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
<script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="875679d7145ae8b3c4db5168c2" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://realvz.github.io/blog/" crossorigin="anonymous"></script>
<link href="https://realvz.github.io/blog/webmentions/receive/" rel="webmention">
<script defer src="/public/cards.min.js?v=ce0a9a97d4"></script>
<link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=ce0a9a97d4">
<script defer src="/public/member-attribution.min.js?v=ce0a9a97d4"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-B5XRB3YVTR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B5XRB3YVTR');
</script><style>:root {--ghost-accent-color: #3a88fe;}</style>
</head>
<body class="post-template has-serif-title has-serif-body">
<div class="site">
<header class="site-header container">
<div class="navbar">
<div class="navbar-left">
<div class="burger hidden-lg hidden-xl"></div>
<a class="logo" href="https://realvz.github.io/blog">
<span class="logo-text">Re Alvarez Parmar&#x27;s Blog</span>
</a> <div class="sep hidden-xs hidden-sm hidden-sm"></div>
<nav class="main-menu hidden-xs hidden-sm hidden-md">
<ul class="nav-list u-plain-list">
<li class="menu-item menu-item-home"><a class="menu-item-link" href="https://realvarez.com">Home</a></li>
<li class="menu-item menu-item-about"><a class="menu-item-link" href="https://realvz.github.io/blog/about/">About</a></li>
</ul>
</nav>
</div>
<div class="navbar-right">
<div class="toggle-track">
<div class="toggle-moon"><i class="icon icon-brightness-2"></i></div>
<div class="toggle-sun"><i class="icon icon-white-balance-sunny"></i></div>
<div class="toggle-thumb"></div>
</div>
</div>
</div>
</header> <div class="site-content">
<div class="content-area">
<main class="site-main">
<article class="post single-post">
<header class="post-header big-title container medium">
<h1 class="post-title">Use containerd to handle k8s.gcr.io deprecation</h1>
<div class="post-meta">
<span class="post-meta-item post-meta-date">
<time datetime="2023-04-04">Apr 4, 2023</time>
</span>
<span class="post-meta-item post-meta-length">
5 min read
</span>
</div>
</header> <figure class="post-media container large">
<div class="u-placeholder horizontal">
<a class="post-image-link" href="/use-containerd-to-handle-k8s-gcr-io-deprecation/">
<img class="post-image lazyload u-object-fit" data-srcset="https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;400 400w, https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;750 750w, https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960 960w, https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1140 1140w, https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;1920 1920w" data-sizes="auto" src="https://images.unsplash.com/photo-1542159919831-40fb0656b45a?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDEyfHxzdW5zZXR8ZW58MHx8fHwxNjgwNjc3MDgx&amp;ixlib&#x3D;rb-4.0.3&amp;q&#x3D;80&amp;w&#x3D;960" srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Use containerd to handle k8s.gcr.io deprecation">
</a>
</div>
<figcaption>Photo by <a href="https://unsplash.com/@mullins?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit">David Mullins</a> / <a href="https://unsplash.com/?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit">Unsplash</a></figcaption>
</figure>
<div class="post-content gh-content kg-canvas">
<p>The Kubernetes community is getting ready for yet another major change. Until fall 2022, <code>k8s.gcr.io</code> container registry hosted many Kubernetes community-managed container images like Cluster Autoscaler, metrics-server, cluster-proportional-autoscaler. The “gcr.io” is Google Cloud Registry. In order to be vendor neutral, the community is moving away from using Google Cloud Registry to host container images.</p><p>As a result, starting March 20th, traffic from the old <code>k8s.gcr.io</code> registry is being redirected to <code>registry.k8s.io</code>. The older <code>k8s.gcr.io</code> will remain functioning for sometime but it is eventually getting deprecated.</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/13FE78CC-1DDD-47D9-B875-EE3FB15F916E/FC421666-8104-4CD9-8C7F-8E4F4BCE2B83_2/6olkWYEK1kl10toAonqYL40P1ZSQIUY2N6iHRwId78kz/Image.jpeg" class="kg-image" alt="Image.jpeg" loading="lazy"></figure><h2 id="what%E2%80%99s-the-impact">What’s the impact?</h2><p>The change that occurred six days after Pi day is unlikely to cause major problems. There are some edge cases. But unless you operate in an airgapped or highly restrictive environment that applies strict domain name access controls, you won’t notice the change.</p><p>This doesn’t mean that there’s no action required. Now is the time to scan code repositories and clusters for usage of the old registry. Failing to act will result in cluster components failing.</p><p>Once the old registry goes away, <strong>Kubernetes will not be able to create new Pods</strong> (unless image is cached) if the container uses an image hosted on <code>k8s.gcr.io</code>.</p><h2 id="what-do-you-need-to-change">What do you need to change?</h2><p>Cluster owners and development teams have to ensure they are not using any images stored in the old registry. The change is fairly simple. It's pretty simple, really.</p><p>You need to change your manifests to use <code>registry.k8s.io</code> container registry.</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/13FE78CC-1DDD-47D9-B875-EE3FB15F916E/EB0981CC-3DC8-49EE-A6F5-A857A69CC949_2/D0F0mQ2JMAl55JNCuS66lUylRznVZywEMdojiRqkc0sz/Image.png" class="kg-image" alt="Image.png" loading="lazy"></figure><p>You can find out which Pods use the old registry using <code>kubectl</code>:</p><pre><code class="language-bash">kubectl get pods --all-namespaces -o jsonpath="{.items[*].spec.containers[*].image}" |\0;31;37M0;31;38m
tr -s '[[:space:]]' '\n' |\
sort |\
uniq -c | grep -i gcr.io
</code></pre><p>Here are the Pods in my test cluster that use the old registry:</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/13FE78CC-1DDD-47D9-B875-EE3FB15F916E/ED8BD697-7BD9-4D58-83FC-833C66606E97_2/dcAQoH7ADPaoupccwi3WFMxt1PkS5ME4zXHHyxjAmdMz/Image.jpeg" class="kg-image" alt="Image.jpeg" loading="lazy"></figure><p>These are the at-risk Pods. I’ll have to update the container registry used in the Pods.</p><p>When hunting for references to old registry, be sure to include containers that may not be currently running in your cluster. Don't forget to scan code repositories. </p><h2 id="what-if-i-don%E2%80%99t-control-the-workloads">What if I don’t control the workloads?</h2><p>One of my colleagues raised an intriguing question. Is there’s a way to handle this change at a cluster level? He had a valid concern. Many large enterprises might not be able to implement this change in time before the community sunsets <code>k8s.gcr.io</code>.</p><p>I work with many customers that manage large Kubernetes clusters, but have little control over the workloads that get deployed into the cluster. Some of these clusters are shared by hundreds of development teams. The burden is on Central Platform Engineering teams to dissipate this information to individual dev teams (who are busy writing code and not checking Kubernetes news!).</p><p>So, what can these teams do to make sure when the old registry finally croaks, they don’t get paged for in the middle of the night for <code>ErrImagePull</code> and <code>ImagePullBackOff</code>errors?</p><p>Turns out you can use containerd to handle this redirection at node level. Let’s find out how.</p><h2 id="using-mirrors-in-containerd">Using mirrors in containerd</h2><p>Ever since Dockerhub started rate limiting image pulls, many have opted to store images in local registries. Mirrors save network bandwidth, reduce image pull time, and don’t rate-limit.</p><p>You can configure <code>registry.k8s.io</code> as a mirror to <code>k8s.gcr.io</code> in containerd. This configuration will <strong>automatically pull images from <code>registry.k8s.io</code></strong> whenever a Pod uses an image stored in <code>k8s.gcr.io</code>.</p><p>On your worker node, append these lines in the containerd config file at <code>/etc/containerd/config.toml</code>:</p><pre><code class="language-bash">[plugins."io.containerd.grpc.v1.cri".registry]
   config_path = "/etc/containerd/certs.d"
</code></pre><p>The final file on an Amazon EKS cluster looks like this:</p><pre><code class="language-yaml">version = 2
root = "/var/lib/containerd"
state = "/run/containerd"

[grpc]
address = "/run/containerd/containerd.sock"

[plugins."io.containerd.grpc.v1.cri".containerd]
default_runtime_name = "runc"

[plugins."io.containerd.grpc.v1.cri"]
sandbox_image = "602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/pause:3.5"

[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
runtime_type = "io.containerd.runc.v2"

[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
SystemdCgroup = true

[plugins."io.containerd.grpc.v1.cri".cni]
bin_dir = "/opt/cni/bin"
conf_dir = "/etc/cni/net.d"

[plugins."io.containerd.grpc.v1.cri".registry]
config_path = "/etc/containerd/certs.d"
</code></pre><p>Next, create a directory called <code>k8s.gcr.io</code> and a <code>hosts.toml</code> file inside it:</p><pre><code class="language-bash">mkdir -p /etc/containerd/certs.d/k8s.gcr.io

cat &lt;&lt; EOF &gt; /etc/containerd/certs.d/k8s.gcr.io/hosts.toml
server = "https://k8s.gcr.io"

[host."https://registry.k8s.io"]
capabilities = ["pull", "resolve"]
EOF
</code></pre><p>Image pull requests to <code>k8s.gcr.io</code> will now be sent to <code>registry.k8s.io</code>.</p><p>Restart containerd and kubelet for the change to take effect.</p><pre><code class="language-bash">systemctl restart containerd kubelet
</code></pre><p>Let’s validate that images are indeed getting pulled from the new registry. I added an entry to my <code>/etc/hosts</code> file to break <code>k8s.gcr.io</code>:</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/13FE78CC-1DDD-47D9-B875-EE3FB15F916E/8AEBA792-CA42-4C8B-9C8D-E34AC55A9847_2/7A4cAKtUBNGVqmUysXRwpW0WGy3cNGz14xxujKlsmc8z/Image.png" class="kg-image" alt="Image.png" loading="lazy"></figure><p>Containerd can no longer pull an image from <code>k8s.gcr.io</code></p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/13FE78CC-1DDD-47D9-B875-EE3FB15F916E/D382C5B0-437D-44E3-BAA2-E32032FF7E29_2/zmbCw5wl0LyV1TNJdiEQxCnSqKBS3s4IDZWYljKaLvkz/Image.jpeg" class="kg-image" alt="Image.jpeg" loading="lazy"></figure><p>I can tell <code>ctr</code> to use the mirror by specifying the <code>—hosts-dir</code> parameter:</p><pre><code class="language-bash">ctr images pull --hosts-dir "/etc/containerd/certs.d" k8s.gcr.io/pause:latest
</code></pre><p>This time the operation succeeds.</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/13FE78CC-1DDD-47D9-B875-EE3FB15F916E/94C5856D-E54D-414D-86E6-5B7C70A7989B_2/2bTbUm39iI52DAfS4D9GgH1T1LW5pBbWxTHNIjgS2v4z/Image.jpeg" class="kg-image" alt="Image.jpeg" loading="lazy"></figure><p>Any Pods I create now onwards will use the new registry even though the manifests reference old registry. Here’s a test using a pause container.</p><pre><code class="language-bash">kubectl create deployment pause --image k8s.gcr.io/pause
</code></pre><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/9d54cc03-adfe-f72f-3389-565eb7356d1d/doc/13FE78CC-1DDD-47D9-B875-EE3FB15F916E/88014DF3-E73E-4A60-B881-64C31B8210B6_2/lnuzXKg7G4RwURvQUxrZwRFuBDljKWpX6m01nVydnxoz/Image.jpeg" class="kg-image" alt="Image.jpeg" loading="lazy"></figure><p>Perfect! Kubernetes could create Pods even though I blocked <code>k8s.gcr.io</code> on the node.</p><h2 id="what%E2%80%99s-the-best-way-to-implement-this-in-production">What’s the best way to implement this in production?</h2><p>In my little demo, I changed a single node in the cluster. What about the rest of the nodes?</p><p>There are three ways you can use to implement this change on every node in your cluster:</p><ol><li>The easiest way is to use a daemonset to change to containerd config.toml and add hosts.toml file. IBM cloud has shared <a href="https://raw.githubusercontent.com/IBM-Cloud/kube-samples/master/containerd-registry-daemonset-example?ref=blog.realvarez.com">this</a> on Github</li><li>You can use <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html?ref=blog.realvarez.com">EC2 user data</a> or <a href="https://aws.amazon.com/systems-manager/?ref=blog.realvarez.com">AWS Systems Manager</a> to make this change when a node gets created</li><li>You can <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-ami-build-scripts.html?ref=blog.realvarez.com">create your own AM</a>I</li></ol><h2 id="what-if-i-use-docker-as-runtime">What if I use Docker as runtime?</h2><p>Starting Kubernetes version <code>1.24</code>, containerd is the only runtime available in Amazon EKS AMIs. If you have an edge case that requires using Docker, there's still hope.</p><p>Docker also has support for registry mirrors. <a href="https://docs.docker.com/registry/recipes/mirror/?ref=blog.realvarez.com#configure-the-docker-daemon">Here’s</a> the documentation page you need.</p><h2 id="don%E2%80%99t-rely-on-stop-gaps">Don’t rely on stop gaps</h2><p>While the solution included in this post works, I recommend only using as a safety measure. The main reason is that you’ll need to customize the Amazon EKS AMI or create your own AMI to use it. </p><p>You’ll have less operational overhead if you can simply use EKS AMIs as is. The best way to handle this registry deprecation is to update manifests.</p><p>Oh, and by the way, you can also use mirrors to enforce pull through cache.</p>
</div>
<div class="container medium">
<div class="share u-hover-wrapper">
<a class="share-item share-facebook u-hover-item" href="https://www.facebook.com/sharer.php?u=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/" target="_blank" rel="noopener"><i class="icon icon-facebook"></i></a>
<a class="share-item share-twitter u-hover-item" href="https://twitter.com/intent/tweet?url=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/&text=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation" target="_blank" rel="noopener"><i class="icon icon-twitter"></i></a>
<a class="share-item share-pinterest u-hover-item" href="https://pinterest.com/pin/create/button/?url=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/&media=&description=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation" target="_blank" rel="noopener" data-pin-do="none"><i class="icon icon-pinterest"></i></a>
<a class="share-item share-linkedin u-hover-item" href="https://www.linkedin.com/shareArticle?mini=true&url=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/&title=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation" target="_blank" rel="noopener"><i class="icon icon-linkedin"></i></a>
<a class="share-item share-reddit u-hover-item" href="https://reddit.com/submit?url=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/&title=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation" target="_blank" rel="noopener"><i class="icon icon-reddit"></i></a>
<a class="share-item share-tumblr u-hover-item" href="https://www.tumblr.com/widgets/share/tool?canonicalUrl=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/&title=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation" target="_blank" rel="noopener"><i class="icon icon-tumblr"></i></a>
<a class="share-item share-vk u-hover-item" href="http://vk.com/share.php?url=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/&title=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation" target="_blank" rel="noopener"><i class="icon icon-vk"></i></a>
<a class="share-item share-pocket u-hover-item" href="https://getpocket.com/edit?url=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/" target="_blank" rel="noopener"><i class="icon icon-pocket"></i></a>
<a class="share-item share-telegram u-hover-item" href="https://t.me/share/url?url=https://realvz.github.io/blog/use-containerd-to-handle-k8s-gcr-io-deprecation/&text=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation" target="_blank" rel="noopener"><i class="icon icon-telegram"></i></a>
</div> </div>
</article>
<div class="navigation container medium">
<div class="navigation-item navigation-previous">
<a class="navigation-item-link button-arrow button-arrow-left" href="/reduce-amazon-eks-cost-by-scaling-node-groups-to-zero/">
<i class="button-arrow-icon icon icon-arrow-left"></i> Previous Post
</a>
</div>
<div class="navigation-item navigation-next">
<a class="navigation-item-link button-arrow button-arrow-right" href="/get-more-out-of-gpus-with-nvidia-multi-instance-gpu/">
Next Post <i class="button-arrow-icon icon icon-arrow-right"></i>
</a>
</div>
</div> </main>
</div>
</div>
<footer class="site-footer container large">
<div class="copyright">
Powered by <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a>
</div>
<nav class="footer-nav">
<ul class="nav-list u-plain-list">
<li class="menu-item menu-item-sign-up"><a class="menu-item-link" href="https://realvz.github.io/blog/#/portal/">Sign up</a></li>
</ul>
</nav>
<div class="footer-social">
<a class="footer-social-item footer-social-item-twitter" href="https://twitter.com/realz" target="_blank" rel="noopener" aria-label="Twitter">
<i class="icon icon-twitter"></i>
</a>
<a class="footer-social-item footer-social-item-rss" href="https://feedly.com/i/subscription/feed/https://realvz.github.io/blog/rss/" target="_blank" rel="noopener" aria-label="RSS">
<i class="icon icon-rss"></i>
</a>
</div>
</footer> </div>
<div class="dimmer"></div>
<div class="off-canvas">
<div class="canvas-close">
<i class="canvas-icon icon icon-window-close"></i>
</div>
<div class="mobile-menu"></div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous">
    </script>
<script src="/assets/built/main.min.js?v=ce0a9a97d4"></script>
</body>
</html>